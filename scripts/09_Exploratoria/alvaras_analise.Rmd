---
title: "Análise exploratória dos alvarás de licenciamento da PMSP/SMUL"
author: "Por Evandro Luis"
date: "Em `r format(Sys.time(), '%d de %B de %Y')`"

---

```{css, echo=FALSE}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
background-color: #bcbec0;
border-color: #bcbec0;
}

.nav>li>a {
color: #f69679;
}

body {
text-align: justify;
}

#TOC {
text-align: left;
background: url("https://www.insper.edu.br/wp-content/uploads/2019/11/logo-insper-arqfuturo-2.png");
background-size: contain;
padding-top: 80px !important;
background-repeat: no-repeat;
}

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, tidy = TRUE, 
                      fig.dim=c(16,12), out.width = "100%",  fig.retina = 2)

options(
  # Definindo novo default de cores adequado à paleta de cores do Insper
  ggplot2.discrete.colour = c("#009491", "#c4161c"),
  ggplot2.discrete.fill = c("#009491", "#c4161c")
  
)

library(here)
library(sf)
library(sfarrow)
library(arrow)
library(tidyverse)
library(tidylog)
library(skimr)
library(DataExplorer)
library(plotly)
library(gt)
library(scales)
```


```{r}
alvaras_por_lote_tidy <- sfarrow::st_read_parquet(
  here("inputs", "2_trusted", "Licenciamentos",
       "alvaras_por_lote.parquet"))

#
alvaras_sfstats <- arrow::read_parquet(
  here("inputs", "2_trusted", "Licenciamentos", 
       "alvaras_sfstats_no_geo.parquet")
)

```


# Conjunto de dados

As tabelas abaixos trazem uma visão geral do conjunto de dados, bem como apresentam algumas de suas estatísticas descritivas básicas.

## Visão geral
```{r exploring}
# Dando uma olhada no conjunto de dados
alvaras_por_lote_tidy %>%
  mutate(long = st_coordinates(.)[,1],
         lat = st_coordinates(.)[,2]) %>%
  st_drop_geometry() %>%
  slice_sample(n = 10) %>%
  gt() %>%
  tab_options(table.font.size = 8.5,
              table.width = pct(100),
              column_labels.font.weight = "bolder") 
```

```{r intro-dates}
## Variável do tipo data

# Analisando estatísticas descritivas gerais: datas
# skim(st_drop_geometry(alvaras_por_lote_tidy)) %>%
#   filter(skim_type=="Date") %>%
#   keep(~!is.na(.) && !is.logical(.)) %>%
#   transmute("Variável" = skim_variable, 
#             "Não-respostas" = n_missing,
#             "Taxa de resposta" = label_percent()(complete_rate),
#             "Mínimo" = Date.min,
#             "Máximo" = Date.max,
#             "Mediana" = Date.median,
#             "Valores únicos" = Date.n_unique) %>%
#   gt() %>% 
#   opt_align_table_header('left') %>%
#   tab_options(table.align = "left", table.font.size = 14,
#               table.width = pct(100),
#               column_labels.font.weight = "bolder")

```

## Variáveis do tipo categórico
```{r intro-factors}
# Analisando estatísticas descritivas gerais: variáveis categóricas
st_drop_geometry(alvaras_por_lote_tidy) %>%
  mutate(across(where(is.character), as.factor)) %>%
  skim() %>%
  arrange(skim_variable) %>%
  filter(skim_type=="factor") %>%
   transmute("Variável" = skim_variable,
            "Não-respostas" = n_missing,
            "Taxa de resposta" = label_percent(accuracy = 0.1)(complete_rate),
            "Valores únicos" = factor.n_unique,
            "Valores mais frequentes" = factor.top_counts) %>%
  keep(~!is.na(.) && !is.logical(.)) %>%
  gt() %>%
  opt_align_table_header('left') %>%
  tab_options(table.align = "left", table.font.size = 14,
              table.width = pct(100),
              column_labels.font.weight = "bolder")
```

## Variáveis do tipo numérico
```{r intro-numerics}
# Analisando estatísticas descritivas gerais: variáveis numéricas
skim(st_drop_geometry(alvaras_por_lote_tidy) %>% select(-id, -ano_execucao)) %>%
  arrange(skim_variable) %>%
  filter(skim_type=="numeric") %>%
  keep(~!is.na(.) && !is.logical(.)) %>%
  transmute("Variável" = skim_variable, 
            "Não-respostas" = n_missing,
            "Taxa de resposta" = label_percent(accuracy = 0.1)(complete_rate),
            "Média" = round(numeric.mean, 1),
            "Desvio-padrão" = round(numeric.sd, 1),
            "Histograma" = numeric.hist,
            "Mínimo" = round(numeric.p0, 1),
            "Percentil 25" = round(numeric.p25, 1),
            "Percentil 50" = round(numeric.p50, 1),
            "Percentil 75" = round(numeric.p75, 1),
            "Máximo" = round(numeric.p100, 1)) %>%
  gt() %>%
  opt_align_table_header('left') %>%
   tab_options(table.align = "left", table.font.size = 14,
              table.width = pct(100),
              column_labels.font.weight = "bolder")

```

# Indicadores espaciais

## Indicadores espaciais dos empreendimentos por tipo (2013-2015 e 2019-2021)

Estatísticas I de Moran indicam contiguidade espacial e estatísticas G indicam concentração espacial

```{r}
# Incluir na tabela acima a evolução de um índice de entropia. Te passo os detalhes de como calcular. Minha hipótese é que o índice de entropia tenha reduzido para os dois tipos de empreendimentos. 
table_alvaras_sfstats <- alvaras_sfstats %>%
  mutate(across(where(is.numeric), ~ (round(.x, 4)))) %>%
  transmute(var = if_else(var == "n_alvaras", "Por empreendimentos",
                          "Por unidades"),
            "Período" = factor(periodo, 
                               levels = c("2013-2015","2019-2021")),
            # "Moran - Global" = Moran_global, 
            "ERP - G" = g_ERP, "ERM - G" = g_ERM,
            "ERP - Moran" = Moran_ERP, "ERM - Moran" = Moran_ERM,
            "Entropia" = entropia) %>%
  arrange(`Período`) %>%
  group_by(var) %>%
  gt(rowname_col = "Período") %>%
  tab_header(title = "",
             subtitle = '') %>% 
  tab_source_note(source_note = md("**Elaboração**: Laboratório Arq.Futuro - Insper | **Dados**: ABRAINC/Prefeitura de São Paulo")) %>%
  tab_options(#column_labels.font.weight = "bolder",
    heading.align = "left",
    table.align = "left",
    row_group.font.weight = "bold",
    source_notes.font.size = 10,
    table.width = pct(100)) %>%
  opt_align_table_header('left') %>%
  cols_align("center") %>%
  data_color(
    columns = contains("Moran"),
    color = scales::col_numeric(
      palette = paletteer::paletteer_d(
        palette = "ggsci::grey_material"
      ) %>% as.character(),
      domain = NULL)
  ) %>%
  data_color(
    columns = !contains("Moran"),
    color = scales::col_numeric(
      palette = paletteer::paletteer_d(
        palette = "ggsci::grey_material"
      ) %>% as.character(),
      domain = NULL)
  ) %>%
  tab_spanner(
    md("**Concentração**"),
    3:4) %>%
  tab_spanner(
    label = md("**Contiguidade**"),
    columns = c(5:6)
  ) %>%
  cols_width(everything() ~ px(60))


#
table_alvaras_sfstats

# 
# #
# gtsave(table_alvaras_sfstats, "alvaras_summary_sfstats.png",
#        here("outputs", "Exploratoria"))

```

# Outros

```{r}
#
cor(alvaras_por_lote_tidy$n_unidades, alvaras_por_lote_tidy$area_da_construcao, 
    use = "complete.obs")
```



```{r}
# 296 de 1102 (21%) dos EETU's não se adequam ao indicador de EETU
alvaras_por_lote_tidy %>%
  st_drop_geometry() %>%
  filter(zoneamento_grupo == "EETU") %>%
  count()
```


```{r}
#
alvaras_por_lote_tidy %>%
  st_drop_geometry() %>%
  filter(macroarea == "MEM") %>%
  count(zoneamento_grupo, zoneamento_grupo == "EETU")

```


```{r}
#
st_drop_geometry(alvaras_por_lote_tidy) %>% 
  select(-starts_with("id")) %>%
  select(-c(macroarea, solo_uso, zoneamento)) %>%
  keep(is.numeric) %>%
  plot_correlation(cor_args = list(use = "pairwise.complete.obs"),
                   ggtheme = list(theme_minimal(base_family = "lato", 
                                                base_size = 12)),
                   theme_config = list(legend.position = "none",
                                       axis.title = element_blank(),
                                       axis.text.x = element_text(angle = 10)))


```



```{r}
#
alvaras_por_lote_tidy %>% 
  select(-id) %>% 
  plot_histogram(ncol = 3)

```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(-id) %>% 
  plot_density(ncol = 3)
```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(area_da_construcao) %>% 
  dplyr::filter(area_da_construcao <= 5000) %>%
  plot_density()

```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(area_do_terreno) %>% 
  dplyr::filter(area_do_terreno <= 4000) %>%
  plot_density()

```

```{r}
#
alvaras_por_lote_tidy %>% 
  select(n_unidades) %>% 
  filter(n_unidades <= 100) %>%
  plot_density()

```

```{r}
#
alvaras_por_lote_tidy %>% 
  select(macroarea) %>%
  plot_bar()
```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(categoria_de_uso_grupo) %>%
  plot_bar()
```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(macroarea, area_da_construcao) %>%
  plot_bar(with = "area_da_construcao")
```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(categoria_de_uso_grupo, area_da_construcao) %>%
  plot_bar(with = "area_da_construcao")
```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(macroarea, n_unidades) %>%
  plot_bar(with = "n_unidades")
```

```{r}

#
alvaras_por_lote_tidy %>% 
  select(categoria_de_uso_grupo, n_unidades) %>%
  plot_bar(with = "n_unidades")
```


```{r}
#
alvaras_por_lote_tidy %>% 
  select(-id) %>%
  plot_bar(maxcat = 2)

```
```{r}
#
alvaras_por_lote_tidy %>% 
  select(-id) %>%
  filter(categoria_de_uso_grupo %in% c("ERM", "ERP")) %>%
  plot_boxplot(by = "categoria_de_uso_grupo", ncol = 2)
```


```{r}

#
alvaras_por_lote_tidy %>% 
  ggplot(aes(ano_execucao)) +
  geom_histogram(aes(y = ..density..), bins = 18) +
  geom_density() +
  facet_wrap(~ categoria_de_uso_grupo) +
  scale_x_continuous(breaks = seq(2004, 2022, 1))
```


```{r}
#
alvaras_por_lote_tidy %>% 
  ggplot(aes(ano_execucao)) +
  geom_histogram(bins = 18) +
  facet_wrap(~ categoria_de_uso_grupo) +
  scale_x_continuous(breaks = seq(2004, 2022, 1))

```

```{r}
#
plot_n_unidades <- alvaras_por_lote_tidy %>% 
  ggplot(aes(ano_execucao, n_unidades, color = categoria_de_uso_grupo,
             label = endereco_ultimo)) +
  geom_point() +
  scale_x_continuous(breaks = seq(2004, 2022, 1))
```


```{r}
#
plotly::ggplotly(plot_n_unidades)
```


```{r}
#
plot_area_do_terreno <- alvaras_por_lote_tidy %>% 
  ggplot(aes(ano_execucao, area_do_terreno, color = categoria_de_uso_grupo)) + 
  geom_point() +
  scale_x_continuous(breaks = seq(2004, 2021, 1)) +
  coord_flip()
```


```{r}
#
plotly::ggplotly(plot_area_do_terreno)
```


```{r}
#
plot_cota_parte <- alvaras_por_lote_tidy %>% 
  ggplot(aes(ano_execucao, cota_parte, color = categoria_de_uso_grupo,
             label = endereco_ultimo)) +
  geom_point() +
  scale_x_continuous(breaks = seq(2004, 2022, 1)) +
  coord_flip()
```

```{r}

#
plotly::ggplotly(plot_cota_parte)
```


```{r}
# Nenhum alvará deve ter distância superior a 50 km da praça da Sé
st_drop_geometry(alvaras_por_lote_tidy) %>% 
  select(distancia_cbd, macroarea) %>%
  filter(distancia_cbd > 50) %>% count()
```


```{r}
#
st_drop_geometry(alvaras_por_lote_tidy) %>% 
  select(distancia_cbd, macroarea) %>%
  filter(distancia_cbd < 50) %>%
  group_by(macroarea) %>%
  summarize(media_distancia_cbd = mean(distancia_cbd, na.rm=TRUE)) %>%
  plot_bar(with = "media_distancia_cbd")

```

```{r}
#
alvaras_por_lote_tidy %>%
  filter(cota_parte < 100) %>%
  ggplot(aes(n_unidades, cota_parte, color = categoria_de_uso_grupo, 
             size = cota_parte)) +
  geom_point(alpha = .5) +
  facet_wrap(~categoria_de_uso_grupo, scales = "free")
```


